networks:
  backhaul:

x-base: &x-base
  networks:
    - backhaul
  restart: unless-stopped

services:
  lightrag:
    <<: *x-base
    hostname: lightrag
    image: ghcr.io/hkuds/lightrag:latest
    ports:
      - "9621:9621"
    volumes:
      - lightrag_storage:/app/data/rag_storage
      - lightrag_inputs:/app/data/inputs
    env_file:
      - docker/lightrag-example.env
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "python -c \"import urllib.request; urllib.request.urlopen('http://localhost:9621/health', timeout=2)\"",
        ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 20s

  mcp:
    <<: *x-base
    build: .
    depends_on:
      lightrag:
        condition: service_healthy
    ports:
      - "8000:8000"
    env_file:
      - docker/mcp-example.env
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "if [ \"$$MCP_TRANSPORT\" = \"stdio\" ]; then exit 0; fi; python -c \"import socket; s=socket.socket(); s.settimeout(2); s.connect(('127.0.0.1', 8000)); s.close()\"",
        ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 20s

volumes:
  lightrag_storage:
  lightrag_inputs: